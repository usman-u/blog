<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>DN42 Part 1: Connecting to the DN42 BGP Mesh | Usman</title><meta name=keywords content="dn42,bgp"><meta name=description content="What is DN42? DN42 is a big network, which employs WAN technologies (BGP, whois database, DNS, etc) to create an internet like mesh.
Members connect to each other using VPN tunnels (GRE, OpenVPN, WireGuard, IPsec) and exchange routes via BGP.
DN42 currently has 410 nodes/users, advertising ~600 prefixes. realtime map
Why DN42? DN42 allows you to experiment with mentioned internet technologies, without the logistical difficulties and high expenses of registering with real AS registries, on the live internet."><meta name=author content="Usman"><link rel=canonical href=https://blog.usman.network/posts/dn42-bgp/><link crossorigin=anonymous href=/assets/css/stylesheet.css rel="preload stylesheet" as=style><script defer crossorigin=anonymous src=/assets/js/highlight.js onload=hljs.initHighlightingOnLoad()></script>
<link rel=icon href=https://blog.usman.network/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://blog.usman.network/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://blog.usman.network/favicon-32x32.png><link rel=apple-touch-icon href=https://blog.usman.network/apple-touch-icon.png><link rel=mask-icon href=https://blog.usman.network/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><noscript><style>#theme-toggle,.top-link{display:none}</style></noscript><script async src="https://www.googletagmanager.com/gtag/js?id=G-KWB2M6CZK2"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-KWB2M6CZK2",{anonymize_ip:!1})}</script><meta property="og:title" content="DN42 Part 1: Connecting to the DN42 BGP Mesh"><meta property="og:description" content="What is DN42? DN42 is a big network, which employs WAN technologies (BGP, whois database, DNS, etc) to create an internet like mesh.
Members connect to each other using VPN tunnels (GRE, OpenVPN, WireGuard, IPsec) and exchange routes via BGP.
DN42 currently has 410 nodes/users, advertising ~600 prefixes. realtime map
Why DN42? DN42 allows you to experiment with mentioned internet technologies, without the logistical difficulties and high expenses of registering with real AS registries, on the live internet."><meta property="og:type" content="article"><meta property="og:url" content="https://blog.usman.network/posts/dn42-bgp/"><meta property="og:image" content="https://blog.usman.network/images/DN42/dn42logo.JPEG"><meta property="article:section" content="posts"><meta property="article:published_time" content="2021-11-22T15:45:37+01:00"><meta property="article:modified_time" content="2021-11-22T15:45:37+01:00"><meta property="og:site_name" content="Usman"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://blog.usman.network/images/DN42/dn42logo.JPEG"><meta name=twitter:title content="DN42 Part 1: Connecting to the DN42 BGP Mesh"><meta name=twitter:description content="What is DN42? DN42 is a big network, which employs WAN technologies (BGP, whois database, DNS, etc) to create an internet like mesh.
Members connect to each other using VPN tunnels (GRE, OpenVPN, WireGuard, IPsec) and exchange routes via BGP.
DN42 currently has 410 nodes/users, advertising ~600 prefixes. realtime map
Why DN42? DN42 allows you to experiment with mentioned internet technologies, without the logistical difficulties and high expenses of registering with real AS registries, on the live internet."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://blog.usman.network/posts/"},{"@type":"ListItem","position":2,"name":"DN42 Part 1: Connecting to the DN42 BGP Mesh","item":"https://blog.usman.network/posts/dn42-bgp/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"DN42 Part 1: Connecting to the DN42 BGP Mesh","name":"DN42 Part 1: Connecting to the DN42 BGP Mesh","description":"What is DN42? DN42 is a big network, which employs WAN technologies (BGP, whois database, DNS, etc) to create an internet like mesh.\nMembers connect to each other using VPN tunnels (GRE, OpenVPN, WireGuard, IPsec) and exchange routes via BGP.\nDN42 currently has 410 nodes/users, advertising ~600 prefixes. realtime map\nWhy DN42? DN42 allows you to experiment with mentioned internet technologies, without the logistical difficulties and high expenses of registering with real AS registries, on the live internet.","keywords":["dn42","bgp"],"articleBody":" What is DN42? DN42 is a big network, which employs WAN technologies (BGP, whois database, DNS, etc) to create an internet like mesh.\nMembers connect to each other using VPN tunnels (GRE, OpenVPN, WireGuard, IPsec) and exchange routes via BGP.\nDN42 currently has 410 nodes/users, advertising ~600 prefixes. realtime map\nWhy DN42? DN42 allows you to experiment with mentioned internet technologies, without the logistical difficulties and high expenses of registering with real AS registries, on the live internet.\nMore importantly, if you misconfigure something, you don’t have to worry about causing global outages - like a Facebook Engineer did.\nHow I connected to the mesh. The Registry The registry is based on a Git repository. This allows users to create branches \u0026 pull requests, to register, create objects and make changes to their details.\nClaiming an IP Range and AS Number. DN42 uses the 172.20.0.0/14 range for IPv4 addresses.\nAvailable IP ranges and ASNs are can be shown in the DN42 Free Explorer. It randomly shows subnets, that are free and useable, from the range.\nDN42’s recommendation is to go with a /27 subnet, which has 30 usable IP addresses, and should be sufficient for most home users.\nFollowing the same process for an ASN and IPv6, I decided to go with:\nAn v4 subnet of 172.22.132.160/27 A v6 range of fd5f:2bd0:1feb::/48 An Autonomous System Number of AS4242421869 Making changes to the git repo. After cloning git the repo to my local machine, I created the following files in the data/ directory:\ndata/aut-num/AS4242421869 - the AS Number.\naut-num: AS4242421869 as-name: AS-USMAN-DN42 admin-c: USMAN-DN42 tech-c: USMAN-DN42 mnt-by: USMAN-MNT source: DN42 data/inet6num/fd5f:2bd0:1feb::_48 - IPv6 Range.\ninet6num: fd5f:2bd0:1feb:0000:0000:0000:0000:0000 - fd5f:2bd0:1feb:ffff:ffff:ffff:ffff:ffff cidr: fd5f:2bd0:1feb::/48 netname: USMAN-NETWORK descr: Network of Usman admin-c: USMAN-DN42 tech-c: USMAN-DN42 mnt-by: USMAN-MNT status: ASSIGNED source: DN42 data/inetnum/172.22.132.160_27 - IPv4 Range.\ninetnum: 172.22.132.160 - 172.22.132.191 cidr: 172.22.132.160/27 netname: USMAN-NETWORK admin-c: USMAN-DN42 tech-c: USMAN-DN42 mnt-by: USMAN-MNT status: ASSIGNED source: DN42 data/mntner/USMAN-MNT - data about the maintainer, including my SSH public key (for verification purposes).\nmntner: USMAN-MNT admin-c: USMAN-DN42 tech-c: USMAN-DN42 mnt-by: USMAN-MNT auth: ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABgQDOVIdUelAhke7DImFiLdLmK5fIqDrj+UC0fMNwaWzzE/Do9s+8OrlLbyA7UNbnLpXEh6xCaE6ckL1j3Nywv8pSgwgZpnZY1smgCDvMqqRpsfqVTYzCy/6f9tzL80km53JLDKeaJSSikzPhcADpp7eCy6QlWPu+cV3om5cDIEuUvpthGfgFNlrtN88o7ryyInnxaHcr+NYWMcyoocVVieCKKbuBhOe+sCj5IFHuHq5IDX7wNbKRauHE47arhrT6aKWBHFkzMNO/XFo5/yhzeC1gzu9J+efmjf6FrjlP5Mvi6PT8tbAmIwpe6y4NZUXfC4cp3bF7L08Av7E8Lb56fBVdc9aWrGyub2Vc8WRGk1UcZoLKFzGO6DAzH2XMqUe7ZY5qHjqbojGgQXNdwCmUIVhAVjs/XCdd2J48/6PdBf2v0zwqf5x6sSwFgntL7a7+WrmIjXDRQx3aIU79djjL6DvFT1kmB6WN9T3zZAqJ5AXq76taRyPcmNmm3dKThCt34Ns= source: DN42 data/person/USMAN-DN42 - contact info.\nperson: Usman e-mail: usman@email.com nic-hdl: USMAN-DN42 mnt-by: USMAN-MNT source: DN42 data/route/172.22.132.160_27 - route for v4.\nroute: 172.22.132.160/27 origin: AS4242421869 mnt-by: USMAN-MNT source: DN42 data/route6/fd5f:2bd0:1feb::_48 - route for v6.\nroute6: fd5f:2bd0:1feb::/48 origin: AS4242421869 max-length: 48 mnt-by: USMAN-MNT source: DN42 I then ran the provided scripts to squash, verify and sign (with my public SSH key) my commits.\nOnce I pushed my commit, I created a pull request and waited for it to be approved. My Routing Daemon. Onto the actual BGP stuff…\nThe Router. While most DN42 users opt for a Bird/Quagga routing daemon on a VPS, I chose to use my existing Ubiquiti EdgeRouter-X. It’s a great router, with a large range of features. See my other post for more info.\nPeering with Kioubit. I peered with the Kioubit Network, as they have automatic peering and a high centrality in the mesh (they have the most neighbours).\nI used Kioubit’s automatic peering wizard to register my ASN, WireGuard public key and tunnel IP. This essentially configures their UK BGP router to listen for a WireGuard peer, which has the correct key.\nWireGuard only requires one peer to have a port open, therefore I didn’t need to publicly open a port on my router.\nTheir side has also been configured to allow BGP advertisements from my ASN and advertise DN42’s prefixes, over the WireGuard tunnel.\nMy Side. WireGuard Tunnel. set interfaces wireguard wg4 address 192.168.219.127/32 set interfaces wireguard wg4 firewall in name DN42_MAIN_IN set interfaces wireguard wg4 firewall local name DN42_MAIN_LOCAL set interfaces wireguard wg4 mtu 1420 set interfaces wireguard wg4 peer allowed-ips 0.0.0.0/0 set interfaces wireguard wg4 peer endpoint 'uk1.g-load.eu:21869' set interfaces wireguard wg4 private-key set interfaces wireguard wg4 route-allowed-ips false What this does:\nCreates a virtual interface called wg4. Assigns it the IP address 192.168.219.127/37 (configured in the Kioubit’s automated peering). Sets the allowed-ips value to 0.0.0.0/0 - this requests to/from any IP address to traverse the tunnel. Defines the Kioubit’s Uk Node’s endpoint and port. Sets the route-allowed-ips value to false, so a default route doesn’t get added to the route table. Adds the interfaces to the firewall group DN42_IN \u0026 DN42_LOCAL more on this later BGP Peering. set protocols bgp 4242421869 neighbor 172.20.53.104 description kioubit set protocols bgp 4242421869 neighbor 172.20.53.104 ebgp-multihop 255 set protocols bgp 4242421869 neighbor 172.20.53.104 remote-as 4242423914 set protocols bgp 4242421869 neighbor 172.20.53.104 soft-reconfiguration inbound set protocols bgp 4242421869 neighbor 172.20.53.104 update-source 172.22.132.161 What this does:\nEnables the BGP routing daemon with my ASN 4242421869. Sets the remote remote AS, with a neighbour IP as 172.20.43.104(kioubit’s IP address in WG tunnel). Sets eBGP Multihop to 255 hops - this is required as the peering is established over a VPN tunnel, not a direct connection. Other BGP and Routing settings. set protocols bgp 4242421869 network 172.22.132.160/27 set protocols bgp 4242421869 parameters router-id 172.22.132.161 set protocols static interface-route 172.20.53.104/32 next-hop-interface wg4 What this does:\nAdvertises the 172.22.132.160/27 prefix (my DN42 subnet). Sets the router ID (which is advertised to peers) to 172.22.132.161. Created a static interface route for Kioubit’s address 172.20.53.104, via wg4. Firewall Rules and security. I used firewall rules to limit the traffic between my network and DN42.\nUbiquiti’s firewalling works by having different ‘directions’. IN and LOCAL.\nIN Matches on established/related and invalid traffic that is passed through the router (WAN to LAN).\nLOCAL Matches on established/related and invalid traffic that is destined for the router itself (WAN to LOCAL).\nDN42_MAIN_IN. set firewall name DN42_MAIN_IN default-action drop set firewall name DN42_MAIN_IN rule 1 action accept set firewall name DN42_MAIN_IN rule 1 description 'Allow established/related' set firewall name DN42_MAIN_IN rule 1 log disable set firewall name DN42_MAIN_IN rule 1 protocol all set firewall name DN42_MAIN_IN rule 1 state established enable set firewall name DN42_MAIN_IN rule 1 state invalid disable set firewall name DN42_MAIN_IN rule 1 state new disable set firewall name DN42_MAIN_IN rule 1 state related enable The IN ruleset has a default action to drop any packets, and only allow any traffic that is established/related. Meaning only any traffic that is initiated from a device in my LAN (not the router) will be allowed.\nIf I wanted to host any services for any other DN42 members, this is where I would add another rule to allow traffic to a specific host \u0026 port. Along with a port forward to bypass NAT.\nDN42_MAIN_LOCAL. set firewall name DN42_MAIN_LOCAL default-action drop set firewall name DN42_MAIN_LOCAL rule 1 action accept set firewall name DN42_MAIN_LOCAL rule 1 description 'Allow established/related' set firewall name DN42_MAIN_LOCAL rule 1 log disable set firewall name DN42_MAIN_LOCAL rule 1 protocol all set firewall name DN42_MAIN_LOCAL rule 1 state established enable set firewall name DN42_MAIN_LOCAL rule 1 state invalid disable set firewall name DN42_MAIN_LOCAL rule 1 state new disable set firewall name DN42_MAIN_LOCAL rule 1 state related enable set firewall name DN42_MAIN_LOCAL rule 2 action accept set firewall name DN42_MAIN_LOCAL rule 2 description 'Allow BGP' set firewall name DN42_MAIN_LOCAL rule 2 destination port 179 set firewall name DN42_MAIN_LOCAL rule 2 log disable set firewall name DN42_MAIN_LOCAL rule 2 protocol tcp The local ruleset also has the same default action and established/related rule. I also have a rule to allow incoming TCP connections on port 179, for BGP.\nThis is where I would create another rule if I wanted to allow DN42 members to access something directly on the router. For example, SSH for administrative purposes.\nSource NAT. I also implemented NAT so that I can access DN42 from any device in my LAN.\nset service nat rule 5050 description 'source NAT for DN42 Peer Kioubit' set service nat rule 5050 log disable set service nat rule 5050 outbound-interface wg4 set service nat rule 5050 outside-address address 172.22.132.162 set service nat rule 5050 protocol all set service nat rule 5050 source set service nat rule 5050 type source Connections destined for the DN42 prefix, will be NAT’ed through the address 172.22.132.162 (one of the IPs in my claimed range).\nFor example, my Raspberry Pi (which is in a local VLAN) can access the DN42 network and run a traceroute to a DN42 IP.\nMaps. At the moment, I have connections with 5 peers. This improves redundancy and provides better access to all areas of the mesh. ","wordCount":"1387","inLanguage":"en","image":"https://blog.usman.network/images/DN42/dn42logo.JPEG","datePublished":"2021-11-22T15:45:37+01:00","dateModified":"2021-11-22T15:45:37+01:00","author":{"@type":"Person","name":"Usman"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://blog.usman.network/posts/dn42-bgp/"},"publisher":{"@type":"Organization","name":"Usman","logo":{"@type":"ImageObject","url":"https://blog.usman.network/favicon.ico"}}}</script></head><body class=dark id=top><script>localStorage.getItem("pref-theme")==="light"&&document.body.classList.remove("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://blog.usman.network/ accesskey=h title="Usman (Alt + H)">Usman</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://blog.usman.network/dn42/ title="DN42 Peering"><span>DN42 Peering</span></a></li><li><a href=https://blog.usman.network/search/ title="Search (Alt + /)" accesskey=/><span>Search</span></a></li><li><a href=https://blog.usman.network/posts/ title=Posts><span>Posts</span></a></li><li><a href=https://blog.usman.network/contact/ title=Contact><span>Contact</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://blog.usman.network/>Home</a>&nbsp;»&nbsp;<a href=https://blog.usman.network/posts/>Posts</a></div><h1 class=post-title>DN42 Part 1: Connecting to the DN42 BGP Mesh</h1><div class=post-meta><span title='2021-11-22 15:45:37 +0100 +0100'>22 November, 2021</span>&nbsp;·&nbsp;7 min&nbsp;·&nbsp;Usman</div></header><figure class=entry-cover><img loading=lazy src=https://blog.usman.network/images/DN42/dn42logo.JPEG alt=alt></figure><div class=toc><details open><summary accesskey=c title="(Alt + C)"><span class=details>Table of Contents</span></summary><div class=inner><ul><li><a href=#what-is-dn42 aria-label="What is DN42?">What is DN42?</a></li><li><a href=#why-dn42 aria-label="Why DN42?">Why DN42?</a></li><li><a href=#how-i-connected-to-the-mesh aria-label="How I connected to the mesh.">How I connected to the mesh.</a><ul><li><a href=#the-registry aria-label="The Registry">The Registry</a></li><li><a href=#claiming-an-ip-range-and-as-number aria-label="Claiming an IP Range and AS Number.">Claiming an IP Range and AS Number.</a></li><li><a href=#making-changes-to-the-git-repo aria-label="Making changes to the git repo.">Making changes to the git repo.</a></li></ul></li><li><a href=#my-routing-daemon aria-label="My Routing Daemon.">My Routing Daemon.</a><ul><li><a href=#the-router aria-label="The Router.">The Router.</a></li><li><a href=#peering-with-kioubit aria-label="Peering with Kioubit.">Peering with Kioubit.</a></li><li><a href=#my-side aria-label="My Side.">My Side.</a><ul><li><a href=#wireguard-tunnel aria-label="WireGuard Tunnel.">WireGuard Tunnel.</a></li><li><a href=#bgp-peering aria-label="BGP Peering.">BGP Peering.</a></li><li><a href=#other-bgp-and-routing-settings aria-label="Other BGP and Routing settings.">Other BGP and Routing settings.</a></li></ul></li><li><a href=#firewall-rules-and-security aria-label="Firewall Rules and security.">Firewall Rules and security.</a><ul><li><a href=#dn42_main_in aria-label=DN42_MAIN_IN.>DN42_MAIN_IN.</a></li><li><a href=#dn42_main_local aria-label=DN42_MAIN_LOCAL.>DN42_MAIN_LOCAL.</a></li></ul></li><li><a href=#source-nat aria-label="Source NAT.">Source NAT.</a></li><li><a href=#maps aria-label=Maps.>Maps.</a></li></ul></li></ul></div></details></div><div class=post-content><hr><h2 id=what-is-dn42>What is DN42?<a hidden class=anchor aria-hidden=true href=#what-is-dn42>#</a></h2><p>DN42 is a big network, which employs WAN technologies (BGP, whois database, DNS, etc) to create an internet like mesh.</p><p>Members connect to each other using VPN tunnels (GRE, OpenVPN, WireGuard, IPsec) and exchange routes via BGP.</p><p><img loading=lazy src=/images/DN42/map.JPG alt="DN42 Mesh" title="DN42 Mesh"></p><p><em>DN42 currently has 410 nodes/users, advertising ~600 prefixes. <a href=https://map42.0x7f.cc/>realtime map</a></em></p><hr><h2 id=why-dn42>Why DN42?<a hidden class=anchor aria-hidden=true href=#why-dn42>#</a></h2><p>DN42 allows you to experiment with mentioned internet technologies, without the logistical difficulties and high expenses of registering with real AS registries, on the live internet.</p><p>More importantly, if you misconfigure something, you don&rsquo;t have to worry about causing global outages - <a href=https://blog.cloudflare.com/october-2021-facebook-outage/>like a Facebook Engineer did.</a></p><p><img loading=lazy src=/images/DN42/bgpmeme.png alt="Facebook BGPMeme" title="FB BGP Meme"></p><hr><h2 id=how-i-connected-to-the-mesh>How I connected to the mesh.<a hidden class=anchor aria-hidden=true href=#how-i-connected-to-the-mesh>#</a></h2><h3 id=the-registry>The Registry<a hidden class=anchor aria-hidden=true href=#the-registry>#</a></h3><p><img loading=lazy src=/images/DN42/gitrepo.JPG alt="DN42 Git Registry" title="DN42 Git Registry">
The registry is based on a <a href=https://git.dn42.dev/dn42/registry/>Git repository</a>. This allows users to create branches & pull requests, to register, create objects and make changes to their details.</p><h3 id=claiming-an-ip-range-and-as-number>Claiming an IP Range and AS Number.<a hidden class=anchor aria-hidden=true href=#claiming-an-ip-range-and-as-number>#</a></h3><p>DN42 uses the <code>172.20.0.0/14</code> range for IPv4 addresses.</p><p>Available IP ranges and ASNs are can be shown in the <a href=https://explorer.burble.com/free#/>DN42 Free Explorer.</a> It randomly shows subnets, that are free and useable, from the range.</p><p><img loading=lazy src=/images/DN42/free-explorer.JPG alt="DN42 Free Explorer" title="DN42 Free Explorer"></p><p>DN42&rsquo;s recommendation is to go with a <code>/27</code> subnet, which has 30 usable IP addresses, and should be sufficient for most home users.</p><p>Following the same process for an ASN and IPv6, I decided to go with:</p><ul><li>An v4 subnet of <code>172.22.132.160/27</code></li><li>A v6 range of <code>fd5f:2bd0:1feb::/48</code></li><li>An Autonomous System Number of <code>AS4242421869</code></li></ul><h3 id=making-changes-to-the-git-repo>Making changes to the git repo.<a hidden class=anchor aria-hidden=true href=#making-changes-to-the-git-repo>#</a></h3><p>After cloning git the repo to my local machine, I created the following files in the <code>data/</code> directory:</p><p><code>data/aut-num/AS4242421869</code> - the AS Number.</p><pre tabindex=0><code>aut-num:            AS4242421869
as-name:            AS-USMAN-DN42
admin-c:            USMAN-DN42
tech-c:             USMAN-DN42
mnt-by:             USMAN-MNT
source:             DN42
</code></pre><p><code>data/inet6num/fd5f:2bd0:1feb::_48</code> - IPv6 Range.</p><pre tabindex=0><code>inet6num:           fd5f:2bd0:1feb:0000:0000:0000:0000:0000 - fd5f:2bd0:1feb:ffff:ffff:ffff:ffff:ffff
cidr:               fd5f:2bd0:1feb::/48
netname:            USMAN-NETWORK
descr:              Network of Usman
admin-c:            USMAN-DN42
tech-c:             USMAN-DN42
mnt-by:             USMAN-MNT
status:             ASSIGNED
source:             DN42
</code></pre><p><code>data/inetnum/172.22.132.160_27</code> - IPv4 Range.</p><pre tabindex=0><code>inetnum:            172.22.132.160 - 172.22.132.191
cidr:               172.22.132.160/27
netname:            USMAN-NETWORK
admin-c:            USMAN-DN42
tech-c:             USMAN-DN42
mnt-by:             USMAN-MNT
status:             ASSIGNED
source:             DN42
</code></pre><p><code>data/mntner/USMAN-MNT</code> - data about the maintainer, including my SSH public key (for verification purposes).</p><pre tabindex=0><code>mntner:             USMAN-MNT
admin-c:            USMAN-DN42
tech-c:             USMAN-DN42
mnt-by:             USMAN-MNT
auth:               ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABgQDOVIdUelAhke7DImFiLdLmK5fIqDrj+UC0fMNwaWzzE/Do9s+8OrlLbyA7UNbnLpXEh6xCaE6ckL1j3Nywv8pSgwgZpnZY1smgCDvMqqRpsfqVTYzCy/6f9tzL80km53JLDKeaJSSikzPhcADpp7eCy6QlWPu+cV3om5cDIEuUvpthGfgFNlrtN88o7ryyInnxaHcr+NYWMcyoocVVieCKKbuBhOe+sCj5IFHuHq5IDX7wNbKRauHE47arhrT6aKWBHFkzMNO/XFo5/yhzeC1gzu9J+efmjf6FrjlP5Mvi6PT8tbAmIwpe6y4NZUXfC4cp3bF7L08Av7E8Lb56fBVdc9aWrGyub2Vc8WRGk1UcZoLKFzGO6DAzH2XMqUe7ZY5qHjqbojGgQXNdwCmUIVhAVjs/XCdd2J48/6PdBf2v0zwqf5x6sSwFgntL7a7+WrmIjXDRQx3aIU79djjL6DvFT1kmB6WN9T3zZAqJ5AXq76taRyPcmNmm3dKThCt34Ns=
source:             DN42
</code></pre><p><code>data/person/USMAN-DN42</code> - contact info.</p><pre tabindex=0><code>person:             Usman
e-mail:             usman@email.com
nic-hdl:            USMAN-DN42
mnt-by:             USMAN-MNT
source:             DN42
</code></pre><p><code>data/route/172.22.132.160_27</code> - route for v4.</p><pre tabindex=0><code>route:              172.22.132.160/27
origin:             AS4242421869
mnt-by:             USMAN-MNT
source:             DN42
</code></pre><p><code>data/route6/fd5f:2bd0:1feb::_48</code> - route for v6.</p><pre tabindex=0><code>route6:             fd5f:2bd0:1feb::/48
origin:             AS4242421869
max-length:         48
mnt-by:             USMAN-MNT
source:             DN42
</code></pre><p>I then ran the provided scripts to squash, verify and sign (with my public SSH key) my commits.</p><p><img loading=lazy src=/images/DN42/gitrepowssh.JPG alt="DN42 Git Registry" title="DN42 Git Registry">
Once I pushed my commit, I created a pull request and waited for it to be approved.
<img loading=lazy src=/images/DN42/register-usman.JPG alt="DN42 Git Registry" title="DN42 Git Registry"></p><hr><h2 id=my-routing-daemon>My Routing Daemon.<a hidden class=anchor aria-hidden=true href=#my-routing-daemon>#</a></h2><p><em>Onto the actual BGP stuff&mldr;</em></p><h3 id=the-router>The Router.<a hidden class=anchor aria-hidden=true href=#the-router>#</a></h3><p>While most DN42 users opt for a Bird/Quagga routing daemon on a VPS, I chose to use my existing Ubiquiti EdgeRouter-X. It&rsquo;s a great router, with a large range of features. <a href=https://blog.usman.network/posts/wireguard-vpn-on-a-ubiquiti-edgerouter/><em>See my other post for more info.</em></a></p><h3 id=peering-with-kioubit>Peering with Kioubit.<a hidden class=anchor aria-hidden=true href=#peering-with-kioubit>#</a></h3><p>I peered with the <a href=https://dn42.g-load.eu/>Kioubit Network</a>, as they have automatic peering and a high centrality in the mesh (they have the most neighbours).</p><p>I used Kioubit&rsquo;s automatic peering wizard to register my ASN, WireGuard public key and tunnel IP.
<img loading=lazy src=/images/DN42/kioubit-reg.JPG alt="Registering Kioubit" title="Kioubit Registration">
This essentially configures their UK BGP router to listen for a WireGuard peer, which has the correct key.</p><p>WireGuard only requires one peer to have a port open, therefore I didn&rsquo;t need to publicly open a port on my router.</p><p>Their side has also been configured to allow BGP advertisements from my ASN and advertise DN42&rsquo;s prefixes, over the WireGuard tunnel.</p><hr><h3 id=my-side>My Side.<a hidden class=anchor aria-hidden=true href=#my-side>#</a></h3><h4 id=wireguard-tunnel>WireGuard Tunnel.<a hidden class=anchor aria-hidden=true href=#wireguard-tunnel>#</a></h4><pre tabindex=0><code>set interfaces wireguard wg4 address 192.168.219.127/32
set interfaces wireguard wg4 firewall in name DN42_MAIN_IN
set interfaces wireguard wg4 firewall local name DN42_MAIN_LOCAL
set interfaces wireguard wg4 mtu 1420
set interfaces wireguard wg4 peer &lt;peer pubkey&gt; allowed-ips 0.0.0.0/0
set interfaces wireguard wg4 peer &lt;peer pubkey&gt; endpoint &#39;uk1.g-load.eu:21869&#39;
set interfaces wireguard wg4 private-key &lt;my private key&gt;
set interfaces wireguard wg4 route-allowed-ips false
</code></pre><p><em>What this does:</em></p><ul><li>Creates a virtual interface called <code>wg4</code>.</li><li>Assigns it the IP address <code>192.168.219.127/37</code> (configured in the Kioubit&rsquo;s automated peering).</li><li>Sets the allowed-ips value to <code>0.0.0.0/0</code> - this requests to/from any IP address to traverse the tunnel.</li><li>Defines the Kioubit&rsquo;s Uk Node&rsquo;s endpoint and port.</li><li>Sets the <code>route-allowed-ips</code> value to <code>false</code>, so a default route doesn&rsquo;t get added to the route table.</li><li>Adds the interfaces to the firewall group <code>DN42_IN</code> & <code>DN42_LOCAL</code> <em>more on this later</em></li></ul><hr><h4 id=bgp-peering>BGP Peering.<a hidden class=anchor aria-hidden=true href=#bgp-peering>#</a></h4><pre tabindex=0><code>set protocols bgp 4242421869 neighbor 172.20.53.104 description kioubit
set protocols bgp 4242421869 neighbor 172.20.53.104 ebgp-multihop 255
set protocols bgp 4242421869 neighbor 172.20.53.104 remote-as 4242423914
set protocols bgp 4242421869 neighbor 172.20.53.104 soft-reconfiguration inbound
set protocols bgp 4242421869 neighbor 172.20.53.104 update-source 172.22.132.161
</code></pre><p><em>What this does:</em></p><ul><li>Enables the BGP routing daemon with my ASN 4242421869.</li><li>Sets the remote remote AS, with a neighbour IP as <code>172.20.43.104</code>(kioubit&rsquo;s IP address in WG tunnel).</li><li>Sets eBGP Multihop to 255 hops - this is required as the peering is established over a VPN tunnel, not a direct connection.</li></ul><hr><h4 id=other-bgp-and-routing-settings>Other BGP and Routing settings.<a hidden class=anchor aria-hidden=true href=#other-bgp-and-routing-settings>#</a></h4><pre tabindex=0><code>set protocols bgp 4242421869 network 172.22.132.160/27
set protocols bgp 4242421869 parameters router-id 172.22.132.161
set protocols static interface-route 172.20.53.104/32 next-hop-interface wg4
</code></pre><p><em>What this does:</em></p><ul><li>Advertises the <code>172.22.132.160/27</code> prefix (my DN42 subnet).</li><li>Sets the router ID (which is advertised to peers) to <code>172.22.132.161</code>.</li><li>Created a static interface route for Kioubit&rsquo;s address <code>172.20.53.104</code>, via wg4.</li></ul><hr><h3 id=firewall-rules-and-security>Firewall Rules and security.<a hidden class=anchor aria-hidden=true href=#firewall-rules-and-security>#</a></h3><p>I used firewall rules to limit the traffic between my network and DN42.</p><p>Ubiquiti&rsquo;s firewalling works by having different &lsquo;directions&rsquo;. <code>IN</code> and <code>LOCAL</code>.</p><ul><li><p><code>IN</code> Matches on established/related and invalid traffic that is passed through the router (WAN to LAN).</p></li><li><p><code>LOCAL</code> Matches on established/related and invalid traffic that is destined for the router itself (WAN to LOCAL).</p></li></ul><h4 id=dn42_main_in>DN42_MAIN_IN.<a hidden class=anchor aria-hidden=true href=#dn42_main_in>#</a></h4><pre tabindex=0><code>set firewall name DN42_MAIN_IN default-action drop
set firewall name DN42_MAIN_IN rule 1 action accept
set firewall name DN42_MAIN_IN rule 1 description &#39;Allow established/related&#39;
set firewall name DN42_MAIN_IN rule 1 log disable
set firewall name DN42_MAIN_IN rule 1 protocol all
set firewall name DN42_MAIN_IN rule 1 state established enable
set firewall name DN42_MAIN_IN rule 1 state invalid disable
set firewall name DN42_MAIN_IN rule 1 state new disable
set firewall name DN42_MAIN_IN rule 1 state related enable
</code></pre><p>The <code>IN</code> ruleset has a default action to drop any packets, and only allow any traffic that is established/related. Meaning only any traffic that is initiated from a device in my LAN (not the router) will be allowed.</p><p>If I wanted to host any services for any other DN42 members, this is where I would add another rule to allow traffic to a specific host & port. Along with a port forward to bypass NAT.</p><h4 id=dn42_main_local>DN42_MAIN_LOCAL.<a hidden class=anchor aria-hidden=true href=#dn42_main_local>#</a></h4><pre tabindex=0><code>set firewall name DN42_MAIN_LOCAL default-action drop
set firewall name DN42_MAIN_LOCAL rule 1 action accept
set firewall name DN42_MAIN_LOCAL rule 1 description &#39;Allow established/related&#39;
set firewall name DN42_MAIN_LOCAL rule 1 log disable
set firewall name DN42_MAIN_LOCAL rule 1 protocol all
set firewall name DN42_MAIN_LOCAL rule 1 state established enable
set firewall name DN42_MAIN_LOCAL rule 1 state invalid disable
set firewall name DN42_MAIN_LOCAL rule 1 state new disable
set firewall name DN42_MAIN_LOCAL rule 1 state related enable
set firewall name DN42_MAIN_LOCAL rule 2 action accept
set firewall name DN42_MAIN_LOCAL rule 2 description &#39;Allow BGP&#39;
set firewall name DN42_MAIN_LOCAL rule 2 destination port 179
set firewall name DN42_MAIN_LOCAL rule 2 log disable
set firewall name DN42_MAIN_LOCAL rule 2 protocol tcp
</code></pre><p>The <code>local</code> ruleset also has the same default action and established/related rule. I also have a rule to allow incoming TCP connections on port 179, for BGP.</p><p>This is where I would create another rule if I wanted to allow DN42 members to access something directly on the router. For example, SSH for administrative purposes.</p><hr><h3 id=source-nat>Source NAT.<a hidden class=anchor aria-hidden=true href=#source-nat>#</a></h3><p>I also implemented NAT so that I can access DN42 from any device in my LAN.</p><pre tabindex=0><code>set service nat rule 5050 description &#39;source NAT for DN42 Peer Kioubit&#39;
set service nat rule 5050 log disable
set service nat rule 5050 outbound-interface wg4
set service nat rule 5050 outside-address address 172.22.132.162
set service nat rule 5050 protocol all
set service nat rule 5050 source
set service nat rule 5050 type source
</code></pre><p>Connections destined for the DN42 prefix, will be NAT&rsquo;ed through the address <code>172.22.132.162</code> (one of the IPs in my claimed range).</p><p>For example, my Raspberry Pi (which is in a local VLAN) can access the DN42 network and run a traceroute to a DN42 IP.</p><p><img loading=lazy src=/images/DN42/nat_trace.JPG alt="NAT Trace" title="NAT Traceroute"></p><hr><h3 id=maps>Maps.<a hidden class=anchor aria-hidden=true href=#maps>#</a></h3><p>At the moment, I have connections with 5 peers. This improves redundancy and provides better access to all areas of the mesh.
<img loading=lazy src=/images/DN42/map2.JPG alt="Current DN42 Map" title="Current DN42 Map"></p></div><footer class=post-footer><ul class=post-tags><li><a href=https://blog.usman.network/tags/dn42/>dn42</a></li><li><a href=https://blog.usman.network/tags/bgp/>bgp</a></li></ul><nav class=paginav><a class=prev href=https://blog.usman.network/posts/ibgp-aws/><span class=title>« Prev</span><br><span>DN42 Part 2: Conecting an AWS VPS to DN42, using iBGP and WireGuard.</span></a>
<a class=next href=https://blog.usman.network/posts/wireguard-vpn-on-a-ubiquiti-edgerouter/><span class=title>Next »</span><br><span>Wireguard VPN on a Ubiquiti EdgeRouter</span></a></nav></footer></article></main><footer class=footer><span>&copy; 2022 <a href=https://blog.usman.network/>Usman</a></span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="copy";function s(){t.innerHTML="copied!",setTimeout(()=>{t.innerHTML="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>