<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Hurricane Electric IPv6 Tunnel Broker On a Ubiquiti EdgeRouter | Usman</title><meta name=keywords content><meta name=description content="What is Tunnel Broker? Tunnel Broker (provided by Hurricane Electric) is a service that allows users to connect the IPv6 internet, over IPv4.
How it works It essentially works by establishing a GRE tunnel to one of Hurricane Electric&rsquo;s PoPs, via the IPv4 internet, and then running IPv6 ranges over it.
Why Tunnel Broker? Accessibility I decided to setup Tunnel Broker, as my ISP doesn&rsquo;t support IPv6. This would allow access to IPv6-only services on the internet."><meta name=author content="Usman"><link rel=canonical href=https://blog.usman.network/posts/hurricane-electric-ipv6/><link crossorigin=anonymous href=/assets/css/stylesheet.css rel="preload stylesheet" as=style><script defer crossorigin=anonymous src=/assets/js/highlight.js onload=hljs.initHighlightingOnLoad()></script>
<link rel=icon href=https://blog.usman.network/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://blog.usman.network/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://blog.usman.network/favicon-32x32.png><link rel=apple-touch-icon href=https://blog.usman.network/apple-touch-icon.png><link rel=mask-icon href=https://blog.usman.network/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><noscript><style>#theme-toggle,.top-link{display:none}</style></noscript><script async src="https://www.googletagmanager.com/gtag/js?id=G-KWB2M6CZK2"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-KWB2M6CZK2",{anonymize_ip:!1})}</script><meta property="og:title" content="Hurricane Electric IPv6 Tunnel Broker On a Ubiquiti EdgeRouter"><meta property="og:description" content="What is Tunnel Broker? Tunnel Broker (provided by Hurricane Electric) is a service that allows users to connect the IPv6 internet, over IPv4.
How it works It essentially works by establishing a GRE tunnel to one of Hurricane Electric&rsquo;s PoPs, via the IPv4 internet, and then running IPv6 ranges over it.
Why Tunnel Broker? Accessibility I decided to setup Tunnel Broker, as my ISP doesn&rsquo;t support IPv6. This would allow access to IPv6-only services on the internet."><meta property="og:type" content="article"><meta property="og:url" content="https://blog.usman.network/posts/hurricane-electric-ipv6/"><meta property="og:image" content="https://blog.usman.network/images/he-v6/helogo.png"><meta property="article:section" content="posts"><meta property="article:published_time" content="2022-03-11T15:01:49+00:00"><meta property="article:modified_time" content="2022-03-11T15:01:49+00:00"><meta property="og:site_name" content="Usman"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://blog.usman.network/images/he-v6/helogo.png"><meta name=twitter:title content="Hurricane Electric IPv6 Tunnel Broker On a Ubiquiti EdgeRouter"><meta name=twitter:description content="What is Tunnel Broker? Tunnel Broker (provided by Hurricane Electric) is a service that allows users to connect the IPv6 internet, over IPv4.
How it works It essentially works by establishing a GRE tunnel to one of Hurricane Electric&rsquo;s PoPs, via the IPv4 internet, and then running IPv6 ranges over it.
Why Tunnel Broker? Accessibility I decided to setup Tunnel Broker, as my ISP doesn&rsquo;t support IPv6. This would allow access to IPv6-only services on the internet."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://blog.usman.network/posts/"},{"@type":"ListItem","position":2,"name":"Hurricane Electric IPv6 Tunnel Broker On a Ubiquiti EdgeRouter","item":"https://blog.usman.network/posts/hurricane-electric-ipv6/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Hurricane Electric IPv6 Tunnel Broker On a Ubiquiti EdgeRouter","name":"Hurricane Electric IPv6 Tunnel Broker On a Ubiquiti EdgeRouter","description":"What is Tunnel Broker? Tunnel Broker (provided by Hurricane Electric) is a service that allows users to connect the IPv6 internet, over IPv4.\nHow it works It essentially works by establishing a GRE tunnel to one of Hurricane Electric\u0026rsquo;s PoPs, via the IPv4 internet, and then running IPv6 ranges over it.\nWhy Tunnel Broker? Accessibility I decided to setup Tunnel Broker, as my ISP doesn\u0026rsquo;t support IPv6. This would allow access to IPv6-only services on the internet.","keywords":[],"articleBody":"What is Tunnel Broker? Tunnel Broker (provided by Hurricane Electric) is a service that allows users to connect the IPv6 internet, over IPv4.\nHow it works It essentially works by establishing a GRE tunnel to one of Hurricane Electric’s PoPs, via the IPv4 internet, and then running IPv6 ranges over it.\nWhy Tunnel Broker? Accessibility I decided to setup Tunnel Broker, as my ISP doesn’t support IPv6. This would allow access to IPv6-only services on the internet. Hosting Due to the abundance of IPv6 addresses, Tunnel Broker can provide multiple /48 ranges. Publicly hosting services would be easier as NAT wouldn’t be needed (my end devices would have publicly routable IPv6 addresses). I wouldn’t have to mess around with port forwarding/destination NAT. I would only have to modify WAN firewall rules, to allow inbound WAN traffic to my devices. Configuration Hurricane Electric’s Side HE’s side of the configuration was straight forward. I made an account and created a regular tunnel.\nThis involved providing my public IPv4 address, selecting a HE PoP location, and claiming the /48 and 64 IPv6 ranges. For the purposes of this article, I’ve replaced my real IPv4 and IPv6 ranges.\nIP Addressing For reference:\nHE’s public IPv4 address - 1.1.1.1 HE’s public IPv6 address - aaa:aaa:aaa:aaa::1/64 - HE’s address for their GRE tunnel interface. My client IPv4 address - 6.6.6.6 My client IPv6 address - aaa:aaa:aaa:aaa::2/64 - my address for the local GRE tunnel interface. Routed Ranges - IPv6 ranges that my end devices can use:\nMy Routed /64 - ccc:ccc:ccc:ccc::/64 My Routed /48 - ddd:ddd:ddd::/48 EdgeRouter X Configuration Establishing the GRE Tunnel set interfaces tunnel tun0 address 'aaa:aaa:aaa:aaa::2/64' set interfaces tunnel tun0 description 'HE.NET IPv6 Tunnel' set interfaces tunnel tun0 encapsulation sit set interfaces tunnel tun0 local-ip 6.6.6.6 set interfaces tunnel tun0 multicast disable set interfaces tunnel tun0 remote-ip 1.1.1.1 set interfaces tunnel tun0 ttl 255 set protocols static interface-route6 '::/0' next-hop-interface tun0 This:\nCreates a GRE tunnel called tun0. Sets the GRE encapsulation to SIT. Sets the local and remote tunnel endpoint IPs. Sets an IPv6 default interface route to tun0, so that all IPv6 internet traffic goes down the interface. Testing the GRE Tunnel To verify the GRE tunnel connectivity, I pinged the HE server endpoint (aaa:aaa:aaa:aaa::1).\nusman@usman-erx:~$ ping6 aaa:aaa:aaa:aaa::1 PING aaa:aaa:aaa:aaa::1(aaa:aaa:aaa:aaa::1) 56 data bytes 64 bytes from aaa:aaa:aaa:aaa::1: icmp_seq=1 ttl=120 time=13.7 ms 64 bytes from aaa:aaa:aaa:aaa::1: icmp_seq=2 ttl=120 time=13.7 ms 64 bytes from aaa:aaa:aaa:aaa::1: icmp_seq=3 ttl=120 time=20.7 ms 64 bytes from aaa:aaa:aaa:aaa::1: icmp_seq=4 ttl=120 time=12.0 ms --- aaa:aaa:aaa:aaa::1 ping statistics --- 4 packets transmitted, 4 received, 0% packet loss, time 3009ms rtt min/avg/max/mdev = 12.038/15.082/20.748/3.347 ms usman@usman-erx:~$ From my Edgerouter, I was able to ping the HE IPv6 server endpoint, over the GRE tunnel.\nAn average of 11ms latency - which is more than acceptable.\nI was also able to ping Google’s IPv6 DNS server.\nAs per the IPv6 routing table, any unspecified traffic was routed over the tun0 interface.\nusman@usman-erx:~$ ping6 2001:4860:4860::8888 PING 2001:4860:4860::8888(2001:4860:4860::8888) 56 data bytes 64 bytes from 2001:4860:4860::8888: icmp_seq=1 ttl=120 time=19.4 ms 64 bytes from 2001:4860:4860::8888: icmp_seq=2 ttl=120 time=19.8 ms 64 bytes from 2001:4860:4860::8888: icmp_seq=3 ttl=120 time=13.8 ms 64 bytes from 2001:4860:4860::8888: icmp_seq=4 ttl=120 time=14.0 ms ^C --- 2001:4860:4860::8888 ping statistics --- 4 packets transmitted, 4 received, 0% packet loss, time 3009ms rtt min/avg/max/mdev = 13.854/16.802/19.838/2.836 ms usman@usman-erx:~$ show ipv6 route IPv6 Routing Table Codes: K - kernel route, C - connected, S - static, R - RIP, O - OSPF, IA - OSPF inter area, E1 - OSPF external type 1, E2 - OSPF external type 2, N1 - OSPF NSSA external type 1, N2 - OSPF NSSA external type 2, B - BGP Timers: Uptime IP Route Table for VRF \"default\" S ::/0 [1/0] via ::, tun0, 01w3d04h C ::1/128 via ::, lo, 02w1d22h C aaa:aaa:aaa:aaa::/64 via ::, tun0, 01w3d04h C fe80::/64 via ::, tun0, 01w3d04h IPv6 Router Advertisements Once my EdgeRouter was IPv6 enabled, I set about connecting my end devices. I used router adverts to automatically assign the addresses my devices.\nIt uses a /64 IPv6 prefix (from my routable /48) and the client’s MAC address, to create an IPv6 address. This is a form of Stateless Address Auto Configuration (SLAAC).\nI use router on a stick VLANs, where virtual interfaces are defined on my EdgeRouter. This made is easy to configure the RA.\nE.g. For VLAN 20, I created a /64 subnet out of my original /48 - ddd:ddd:ddd:20::/64.\nset interfaces switch switch0 vif 20 ipv6 address eui64 'ddd:ddd:ddd:20::/64' set interfaces switch switch0 vif 20 ipv6 router-advert name-server '2001:4860:4860::8888' set interfaces switch switch0 vif 20 ipv6 router-advert prefix 'ddd:ddd:ddd:20::/64' This:\nSets vif 20 an ipv6 address, comprised of ddd:ddd:ddd:20::/64 and vif 20’s MAC address. Sets Google’s IPv6 DNS as the name server. Advertises the prefix to the clients. vif 20 was set a IPv6 address of ddd:ddd:ddd:20:7683:c2ff:fef5:dadb/64 - which would be the default gateway for end devices on VLAN 20.\nusman@usman-erx:~$ show interfaces Codes: S - State, L - Link, u - Up, D - Down, A - Admin Down Interface IP Address S/L Description --------- ---------- --- ----------- switch0.20 10.0.20.1/24 u/u IoT ddd:ddd:ddd:20:7683:c2ff:fef5:dadb/64 [..] Verifying Connectivity On End Devices Using SLAAC, my Debian based Raspberry Pi had been delegated the IPv6 address:\ninet6 ddd:ddd:ddd:20:e7d5:6b06:84cd:9ae7 from the ddd:ddd:ddd:20::/64 prefix.\nusman@raspberrypi:~$ sudo ifconfig eth0 eth0: flags=4163 mtu 1500 inet 10.0.10.14 netmask 255.255.255.0 broadcast 10.0.10.255 inet6 fe80::e6ea:3e88:42f3:53e5 prefixlen 64 scopeid 0x20 inet6 ddd:ddd:ddd:20:e7d5:6b06:84cd:9ae7 prefixlen 64 scopeid 0x0 ether e4:5f:01:25:18:aa txqueuelen 1000 (Ethernet) RX packets 667315319 bytes 748041609 (713.3 MiB) RX errors 108935 dropped 108935 overruns 0 frame 0 TX packets 648634493 bytes 464678115 (443.1 MiB) TX errors 0 dropped 0 overruns 0 carrier 0 collisions 0 usman@raspberrypi:~$ To verify connectivity, I also ran a traceroute to Google’s IPv6 DNS server.\nusman@raspberrypi:~$ traceroute6 2001:4860:4860::8888 traceroute to 2001:4860:4860::8888 (2001:4860:4860::8888), 30 hops max, 80 byte packets 1 ddd:ddd:ddd:20:7683:c2ff:fef5:dadb (ddd:ddd:ddd:20:7683:c2ff:fef5:dadb) 0.512 ms 0.421 ms 0.580 ms 2 tunnel718369.tunnel.tserv5.lon1.ipv6.he.net (2001:470:1f08:213::1) 19.324 ms 26.367 ms 17.280 ms 3 e0-19.core2.lon2.he.net (2001:470:0:67::1) 17.346 ms 20.102 ms 22.073 ms 4 2001:7f8:be::1:5169:1 (2001:7f8:be::1:5169:1) 43.789 ms 43.786 ms 43.788 ms 5 2a00:1450:80f9::1 (2a00:1450:80f9::1) 26.844 ms 2a00:1450:8125::1 (2a00:1450:8125::1) 19.985 ms * 6 dns.google (2001:4860:4860::8888) 25.651 ms 13.551 ms 17.539 ms The traceroute confirmed that the traffic goes through my EdgeRouter’s IPv6 interface ddd:ddd:ddd:20:7683:c2ff:fef5:dadb, over the GRE tunnel and HE’s infrastructure, and out to Google.\nFirewalling As my devices had publicly routable IPv6 addresses delegated to them, I added firewall rules to inbound limit traffic.\nI created two firewall lists WAN_IN (from the internet to end devices) and WAN_Local (from the internet to the router).\nset firewall ipv6-name WAN_In default-action drop set firewall ipv6-name WAN_In rule 10 action accept set firewall ipv6-name WAN_In rule 10 description 'allow established/related traffic' set firewall ipv6-name WAN_In rule 10 protocol all set firewall ipv6-name WAN_In rule 10 state established enable set firewall ipv6-name WAN_In rule 10 state related enable set firewall ipv6-name WAN_In rule 20 action drop set firewall ipv6-name WAN_In rule 20 protocol all set firewall ipv6-name WAN_In rule 20 state invalid enable set firewall ipv6-name WAN_In rule 30 action accept set firewall ipv6-name WAN_In rule 30 description 'allow icmpv6' set firewall ipv6-name WAN_In rule 30 protocol icmpv6 set firewall ipv6-name WAN_Local default-action drop set firewall ipv6-name WAN_Local rule 10 action accept set firewall ipv6-name WAN_Local rule 10 description 'allow established/related traffic' set firewall ipv6-name WAN_Local rule 10 protocol all set firewall ipv6-name WAN_Local rule 10 state established enable set firewall ipv6-name WAN_Local rule 10 state related enable set firewall ipv6-name WAN_Local rule 20 action drop set firewall ipv6-name WAN_Local rule 20 protocol all set firewall ipv6-name WAN_Local rule 20 state invalid enable set firewall ipv6-name WAN_Local rule 30 action accept set firewall ipv6-name WAN_Local rule 30 description 'allow icmpv6' set firewall ipv6-name WAN_Local rule 30 protocol icmpv6 Both firewall lists have 3 rules:\nDefault action for inbound traffic is drop. Rule 10 - allows established and related traffic, from WAN to end devices. Rule 20 - drops invalid state packets. Rule 30 - Allows ICMPv6. I then associated the rule lists with the GRE tun0 interface, which filtered the traffic.\nset interfaces tunnel tun0 firewall in ipv6-name WAN_In set interfaces tunnel tun0 firewall local ipv6-name WAN_Local ","wordCount":"1356","inLanguage":"en","image":"https://blog.usman.network/images/he-v6/helogo.png","datePublished":"2022-03-11T15:01:49Z","dateModified":"2022-03-11T15:01:49Z","author":{"@type":"Person","name":"Usman"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://blog.usman.network/posts/hurricane-electric-ipv6/"},"publisher":{"@type":"Organization","name":"Usman","logo":{"@type":"ImageObject","url":"https://blog.usman.network/favicon.ico"}}}</script></head><body class=dark id=top><script>localStorage.getItem("pref-theme")==="light"&&document.body.classList.remove("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://blog.usman.network/ accesskey=h title="Usman (Alt + H)">Usman</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://blog.usman.network/posts/ title=Articles><span>Articles</span></a></li><li><a href=https://dn42.usman.network title="DN42 Peering"><span>DN42 Peering</span>&nbsp;<svg fill="none" shape-rendering="geometricPrecision" stroke="currentcolor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" viewBox="0 0 24 24" height="12" width="12"><path d="M18 13v6a2 2 0 01-2 2H5a2 2 0 01-2-2V8a2 2 0 012-2h6"/><path d="M15 3h6v6"/><path d="M10 14 21 3"/></svg></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://blog.usman.network/>Home</a>&nbsp;»&nbsp;<a href=https://blog.usman.network/posts/>Posts</a></div><h1 class=post-title>Hurricane Electric IPv6 Tunnel Broker On a Ubiquiti EdgeRouter</h1><div class=post-meta><span title='2022-03-11 15:01:49 +0000 UTC'>11 March, 2022</span>&nbsp;·&nbsp;7 min&nbsp;·&nbsp;Usman</div></header><figure class=entry-cover><img loading=lazy src=https://blog.usman.network/images/he-v6/helogo.png alt=alt></figure><div class=toc><details open><summary accesskey=c title="(Alt + C)"><span class=details>Table of Contents</span></summary><div class=inner><ul><ul><li><a href=#what-is-tunnel-broker aria-label="What is Tunnel Broker?">What is Tunnel Broker?</a></li><li><a href=#how-it-works aria-label="How it works">How it works</a></li><li><a href=#why-tunnel-broker aria-label="Why Tunnel Broker?">Why Tunnel Broker?</a><ul><li><a href=#accessibility aria-label=Accessibility>Accessibility</a></li><li><a href=#hosting aria-label=Hosting>Hosting</a></li></ul></li></ul><li><a href=#configuration aria-label=Configuration>Configuration</a><ul><li><a href=#hurricane-electrics-side aria-label="Hurricane Electric&amp;rsquo;s Side">Hurricane Electric&rsquo;s Side</a><ul><li><a href=#ip-addressing aria-label="IP Addressing">IP Addressing</a></li></ul></li><li><a href=#edgerouter-x-configuration aria-label="EdgeRouter X Configuration">EdgeRouter X Configuration</a><ul><li><a href=#establishing-the-gre-tunnel aria-label="Establishing the GRE Tunnel">Establishing the GRE Tunnel</a></li><li><a href=#testing-the-gre-tunnel aria-label="Testing the GRE Tunnel">Testing the GRE Tunnel</a></li><li><a href=#ipv6-router-advertisements aria-label="IPv6 Router Advertisements">IPv6 Router Advertisements</a></li><li><a href=#verifying-connectivity-on-end-devices aria-label="Verifying Connectivity On End Devices">Verifying Connectivity On End Devices</a></li><li><a href=#firewalling aria-label=Firewalling>Firewalling</a></li></ul></li></ul></li></ul></div></details></div><div class=post-content><h2 id=what-is-tunnel-broker>What is Tunnel Broker?<a hidden class=anchor aria-hidden=true href=#what-is-tunnel-broker>#</a></h2><p>Tunnel Broker (provided by Hurricane Electric) is a service that allows users to connect the IPv6 internet, over IPv4.</p><h2 id=how-it-works>How it works<a hidden class=anchor aria-hidden=true href=#how-it-works>#</a></h2><p>It essentially works by establishing a GRE tunnel to one of Hurricane Electric&rsquo;s PoPs, via the IPv4 internet, and then running IPv6 ranges over it.</p><h2 id=why-tunnel-broker>Why Tunnel Broker?<a hidden class=anchor aria-hidden=true href=#why-tunnel-broker>#</a></h2><h3 id=accessibility>Accessibility<a hidden class=anchor aria-hidden=true href=#accessibility>#</a></h3><ul><li>I decided to setup Tunnel Broker, as my ISP doesn&rsquo;t support IPv6.</li><li>This would allow access to IPv6-only services on the internet.</li></ul><h3 id=hosting>Hosting<a hidden class=anchor aria-hidden=true href=#hosting>#</a></h3><ul><li>Due to the abundance of IPv6 addresses, Tunnel Broker can provide multiple <code>/48</code> ranges.</li><li>Publicly hosting services would be easier as NAT wouldn&rsquo;t be needed (my end devices would have publicly routable IPv6 addresses).</li><li>I wouldn&rsquo;t have to mess around with <em>port forwarding/destination NAT</em>. I would only have to modify WAN firewall rules, to allow inbound WAN traffic to my devices.</li></ul><hr><h1 id=configuration>Configuration<a hidden class=anchor aria-hidden=true href=#configuration>#</a></h1><h2 id=hurricane-electrics-side>Hurricane Electric&rsquo;s Side<a hidden class=anchor aria-hidden=true href=#hurricane-electrics-side>#</a></h2><p>HE&rsquo;s side of the configuration was straight forward. I made an account and created a regular tunnel.</p><p>This involved providing my public IPv4 address, selecting a HE PoP location, and claiming the <code>/48</code> and <code>64</code> IPv6 ranges.
<img loading=lazy src=/images/he-v6/tunnel-example.png alt="HE Configuration" title="HE Configuration"></p><p><em>For the purposes of this article, I&rsquo;ve replaced my real IPv4 and IPv6 ranges.</em></p><h3 id=ip-addressing>IP Addressing<a hidden class=anchor aria-hidden=true href=#ip-addressing>#</a></h3><p>For reference:</p><ul><li>HE&rsquo;s public IPv4 address - <code>1.1.1.1</code></li><li>HE&rsquo;s public IPv6 address - <code>aaa:aaa:aaa:aaa::1/64</code> - HE&rsquo;s address for their GRE tunnel interface.</li><li>My client IPv4 address - <code>6.6.6.6</code></li><li>My client IPv6 address - <code>aaa:aaa:aaa:aaa::2/64</code> - my address for the local GRE tunnel interface.</li></ul><p>Routed Ranges - IPv6 ranges that my end devices can use:</p><ul><li>My Routed <code>/64</code> - <code>ccc:ccc:ccc:ccc::/64</code></li><li>My Routed <code>/48</code> - <code>ddd:ddd:ddd::/48</code></li></ul><hr><h2 id=edgerouter-x-configuration>EdgeRouter X Configuration<a hidden class=anchor aria-hidden=true href=#edgerouter-x-configuration>#</a></h2><h3 id=establishing-the-gre-tunnel>Establishing the GRE Tunnel<a hidden class=anchor aria-hidden=true href=#establishing-the-gre-tunnel>#</a></h3><pre tabindex=0><code>set interfaces tunnel tun0 address &#39;aaa:aaa:aaa:aaa::2/64&#39;
set interfaces tunnel tun0 description &#39;HE.NET IPv6 Tunnel&#39;
set interfaces tunnel tun0 encapsulation sit
set interfaces tunnel tun0 local-ip 6.6.6.6
set interfaces tunnel tun0 multicast disable
set interfaces tunnel tun0 remote-ip 1.1.1.1
set interfaces tunnel tun0 ttl 255
set protocols static interface-route6 &#39;::/0&#39; next-hop-interface tun0
</code></pre><p>This:</p><ul><li>Creates a GRE tunnel called <code>tun0</code>.</li><li>Sets the GRE encapsulation to SIT.</li><li>Sets the local and remote tunnel endpoint IPs.</li><li>Sets an IPv6 default interface route to <code>tun0</code>, so that all IPv6 internet traffic goes down the interface.</li></ul><h3 id=testing-the-gre-tunnel>Testing the GRE Tunnel<a hidden class=anchor aria-hidden=true href=#testing-the-gre-tunnel>#</a></h3><p>To verify the GRE tunnel connectivity, I pinged the HE server endpoint (<code>aaa:aaa:aaa:aaa::1</code>).</p><pre tabindex=0><code>usman@usman-erx:~$ ping6 aaa:aaa:aaa:aaa::1
PING aaa:aaa:aaa:aaa::1(aaa:aaa:aaa:aaa::1) 56 data bytes
64 bytes from aaa:aaa:aaa:aaa::1: icmp_seq=1 ttl=120 time=13.7 ms
64 bytes from aaa:aaa:aaa:aaa::1: icmp_seq=2 ttl=120 time=13.7 ms
64 bytes from aaa:aaa:aaa:aaa::1: icmp_seq=3 ttl=120 time=20.7 ms
64 bytes from aaa:aaa:aaa:aaa::1: icmp_seq=4 ttl=120 time=12.0 ms
--- aaa:aaa:aaa:aaa::1 ping statistics ---
4 packets transmitted, 4 received, 0% packet loss, time 3009ms
rtt min/avg/max/mdev = 12.038/15.082/20.748/3.347 ms
usman@usman-erx:~$
</code></pre><p>From my Edgerouter, I was able to ping the HE IPv6 server endpoint, over the GRE tunnel.</p><p>An average of 11ms latency - which is more than acceptable.</p><hr><p>I was also able to ping Google&rsquo;s IPv6 DNS server.</p><p>As per the IPv6 routing table, any unspecified traffic was routed over the <code>tun0</code> interface.</p><pre tabindex=0><code>usman@usman-erx:~$ ping6 2001:4860:4860::8888
PING 2001:4860:4860::8888(2001:4860:4860::8888) 56 data bytes
64 bytes from 2001:4860:4860::8888: icmp_seq=1 ttl=120 time=19.4 ms
64 bytes from 2001:4860:4860::8888: icmp_seq=2 ttl=120 time=19.8 ms
64 bytes from 2001:4860:4860::8888: icmp_seq=3 ttl=120 time=13.8 ms
64 bytes from 2001:4860:4860::8888: icmp_seq=4 ttl=120 time=14.0 ms
^C
--- 2001:4860:4860::8888 ping statistics ---
4 packets transmitted, 4 received, 0% packet loss, time 3009ms
rtt min/avg/max/mdev = 13.854/16.802/19.838/2.836 ms
</code></pre><pre tabindex=0><code>usman@usman-erx:~$ show ipv6 route
IPv6 Routing Table
Codes: K - kernel route, C - connected, S - static, R - RIP, O - OSPF,
       IA - OSPF inter area, E1 - OSPF external type 1,
       E2 - OSPF external type 2, N1 - OSPF NSSA external type 1,
       N2 - OSPF NSSA external type 2, B - BGP
Timers: Uptime

IP Route Table for VRF &#34;default&#34;
S      ::/0 [1/0] via ::, tun0, 01w3d04h
C      ::1/128 via ::, lo, 02w1d22h
C      aaa:aaa:aaa:aaa::/64 via ::, tun0, 01w3d04h
C      fe80::/64 via ::, tun0, 01w3d04h
</code></pre><hr><h3 id=ipv6-router-advertisements>IPv6 Router Advertisements<a hidden class=anchor aria-hidden=true href=#ipv6-router-advertisements>#</a></h3><p>Once my EdgeRouter was IPv6 enabled, I set about connecting my end devices. I used router adverts to automatically assign the addresses my devices.</p><p>It uses a <code>/64</code> IPv6 prefix (from my routable <code>/48</code>) and the client&rsquo;s MAC address, to create an IPv6 address. This is a form of Stateless Address Auto Configuration (SLAAC).</p><p>I use <em>router on a stick VLANs</em>, where virtual interfaces are defined on my EdgeRouter. This made is easy to configure the RA.</p><p>E.g. For VLAN 20, I created a <code>/64</code> subnet out of my original <code>/48</code> - <code>ddd:ddd:ddd:20::/64</code>.</p><pre tabindex=0><code>set interfaces switch switch0 vif 20 ipv6 address eui64 &#39;ddd:ddd:ddd:20::/64&#39;
set interfaces switch switch0 vif 20 ipv6 router-advert name-server &#39;2001:4860:4860::8888&#39;
set interfaces switch switch0 vif 20 ipv6 router-advert prefix &#39;ddd:ddd:ddd:20::/64&#39;
</code></pre><p>This:</p><ul><li>Sets <code>vif 20</code> an ipv6 address, comprised of <code>ddd:ddd:ddd:20::/64</code> and <code>vif 20</code>&rsquo;s MAC address.</li><li>Sets Google&rsquo;s IPv6 DNS as the name server.</li><li>Advertises the prefix to the clients.</li></ul><p><code>vif 20</code> was set a IPv6 address of <code>ddd:ddd:ddd:20:7683:c2ff:fef5:dadb/64</code> - which would be the default gateway for end devices on VLAN 20.</p><pre tabindex=0><code>usman@usman-erx:~$ show interfaces
Codes: S - State, L - Link, u - Up, D - Down, A - Admin Down
Interface    IP Address                            S/L  Description
---------    ----------                            ---  -----------
switch0.20   10.0.20.1/24                          u/u  IoT
             ddd:ddd:ddd:20:7683:c2ff:fef5:dadb/64
[..]
</code></pre><h3 id=verifying-connectivity-on-end-devices>Verifying Connectivity On End Devices<a hidden class=anchor aria-hidden=true href=#verifying-connectivity-on-end-devices>#</a></h3><p>Using SLAAC, my Debian based Raspberry Pi had been delegated the IPv6 address:</p><p><code>inet6 ddd:ddd:ddd:20:e7d5:6b06:84cd:9ae7</code> from the <code>ddd:ddd:ddd:20::/64</code> prefix.</p><pre tabindex=0><code>usman@raspberrypi:~$ sudo ifconfig eth0
eth0: flags=4163&lt;UP,BROADCAST,RUNNING,MULTICAST&gt;  mtu 1500
        inet 10.0.10.14  netmask 255.255.255.0  broadcast 10.0.10.255
        inet6 fe80::e6ea:3e88:42f3:53e5  prefixlen 64  scopeid 0x20&lt;link&gt;
        inet6 ddd:ddd:ddd:20:e7d5:6b06:84cd:9ae7  prefixlen 64  scopeid 0x0&lt;global&gt;
        ether e4:5f:01:25:18:aa  txqueuelen 1000  (Ethernet)
        RX packets 667315319  bytes 748041609 (713.3 MiB)
        RX errors 108935  dropped 108935  overruns 0  frame 0
        TX packets 648634493  bytes 464678115 (443.1 MiB)
        TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0
usman@raspberrypi:~$
</code></pre><p>To verify connectivity, I also ran a traceroute to Google&rsquo;s IPv6 DNS server.</p><pre tabindex=0><code>usman@raspberrypi:~$ traceroute6 2001:4860:4860::8888
traceroute to 2001:4860:4860::8888 (2001:4860:4860::8888), 30 hops max, 80 byte packets
 1  ddd:ddd:ddd:20:7683:c2ff:fef5:dadb (ddd:ddd:ddd:20:7683:c2ff:fef5:dadb)  0.512 ms  0.421 ms  0.580 ms
 2  tunnel718369.tunnel.tserv5.lon1.ipv6.he.net (2001:470:1f08:213::1)  19.324 ms  26.367 ms  17.280 ms
 3  e0-19.core2.lon2.he.net (2001:470:0:67::1)  17.346 ms  20.102 ms  22.073 ms
 4  2001:7f8:be::1:5169:1 (2001:7f8:be::1:5169:1)  43.789 ms  43.786 ms  43.788 ms
 5  2a00:1450:80f9::1 (2a00:1450:80f9::1)  26.844 ms 2a00:1450:8125::1 (2a00:1450:8125::1)  19.985 ms *
 6  dns.google (2001:4860:4860::8888)  25.651 ms  13.551 ms  17.539 ms
</code></pre><p>The traceroute confirmed that the traffic goes through my EdgeRouter&rsquo;s IPv6 interface <code>ddd:ddd:ddd:20:7683:c2ff:fef5:dadb</code>, over the GRE tunnel and HE&rsquo;s infrastructure, and out to Google.</p><hr><h3 id=firewalling>Firewalling<a hidden class=anchor aria-hidden=true href=#firewalling>#</a></h3><p>As my devices had publicly routable IPv6 addresses delegated to them, I added firewall rules to inbound limit traffic.</p><p>I created two firewall lists <code>WAN_IN</code> (from the internet to end devices) and <code>WAN_Local</code> (from the internet to the router).</p><pre tabindex=0><code>set firewall ipv6-name WAN_In default-action drop
set firewall ipv6-name WAN_In rule 10 action accept
set firewall ipv6-name WAN_In rule 10 description &#39;allow established/related traffic&#39;
set firewall ipv6-name WAN_In rule 10 protocol all
set firewall ipv6-name WAN_In rule 10 state established enable
set firewall ipv6-name WAN_In rule 10 state related enable

set firewall ipv6-name WAN_In rule 20 action drop
set firewall ipv6-name WAN_In rule 20 protocol all
set firewall ipv6-name WAN_In rule 20 state invalid enable

set firewall ipv6-name WAN_In rule 30 action accept
set firewall ipv6-name WAN_In rule 30 description &#39;allow icmpv6&#39;
set firewall ipv6-name WAN_In rule 30 protocol icmpv6
</code></pre><pre tabindex=0><code>set firewall ipv6-name WAN_Local default-action drop
set firewall ipv6-name WAN_Local rule 10 action accept
set firewall ipv6-name WAN_Local rule 10 description &#39;allow established/related traffic&#39;
set firewall ipv6-name WAN_Local rule 10 protocol all
set firewall ipv6-name WAN_Local rule 10 state established enable
set firewall ipv6-name WAN_Local rule 10 state related enable

set firewall ipv6-name WAN_Local rule 20 action drop
set firewall ipv6-name WAN_Local rule 20 protocol all
set firewall ipv6-name WAN_Local rule 20 state invalid enable

set firewall ipv6-name WAN_Local rule 30 action accept
set firewall ipv6-name WAN_Local rule 30 description &#39;allow icmpv6&#39;
set firewall ipv6-name WAN_Local rule 30 protocol icmpv6
</code></pre><p>Both firewall lists have 3 rules:</p><ul><li>Default action for inbound traffic is drop.</li><li>Rule 10 - allows established and related traffic, from WAN to end devices.</li><li>Rule 20 - drops invalid state packets.</li><li>Rule 30 - Allows ICMPv6.</li></ul><p>I then associated the rule lists with the GRE <code>tun0</code> interface, which filtered the traffic.</p><pre tabindex=0><code>set interfaces tunnel tun0 firewall in ipv6-name WAN_In
set interfaces tunnel tun0 firewall local ipv6-name WAN_Local
</code></pre></div><footer class=post-footer><ul class=post-tags></ul><nav class=paginav><a class=prev href=https://blog.usman.network/posts/bgp-rpki-roa/><span class=title>« Prev</span><br><span>DN42 Part 3: BGP ROA/RPKI Filtering using Docker</span></a>
<a class=next href=https://blog.usman.network/posts/ibgp-aws/><span class=title>Next »</span><br><span>DN42 Part 2: Conecting an AWS VPS to DN42, using iBGP and WireGuard.</span></a></nav></footer><div id=disqus_thread></div><script type=application/javascript>window.disqus_config=function(){},function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById("disqus_thread").innerHTML="Disqus comments not available by default when the website is previewed locally.";return}var t=document,e=t.createElement("script");e.async=!0,e.src="//blog-usman-network.disqus.com/embed.js",e.setAttribute("data-timestamp",+new Date),(t.head||t.body).appendChild(e)}()</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></article></main><footer class=footer><span>&copy; 2023 <a href=https://blog.usman.network/>Usman</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></a><script src=https://cdnjs.cloudflare.com/ajax/libs/medium-zoom/1.0.6/medium-zoom.min.js integrity="sha512-N9IJRoc3LaP3NDoiGkcPa4gG94kapGpaA5Zq9/Dr04uf5TbLFU5q0o8AbRhLKUUlp8QFS2u7S+Yti0U7QtuZvQ==" crossorigin=anonymous referrerpolicy=no-referrer></script>
<script>const images=Array.from(document.querySelectorAll(".post-content img"));images.forEach(e=>{mediumZoom(e,{margin:0,scrollOffset:40,container:null,template:null})})</script><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="copy";function s(){t.innerHTML="copied!",setTimeout(()=>{t.innerHTML="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>